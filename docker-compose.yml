# Docker Compose for parakeet-rs WebRTC Transcription
#
# Configuration is done entirely via environment variables.
# See docs/webrtc-transcription-architecture.md for full documentation.
#
# Usage:
#   # Start the container
#   docker compose up -d
#
#   # Run the transcriber with audio
#   docker exec parakeet-transcriber sh -c \
#     'ffmpeg -re -i /tmp/broadcast_2.wav -f s16le -ar 16000 -ac 1 - 2>/dev/null | \
#      /app/webrtc_transcriber --speedy'
#
#   # View logs
#   docker compose logs -f transcriber
#
#   # Stop all services
#   docker compose down

services:
  # WebRTC transcription server
  transcriber:
    build:
      context: .
      dockerfile: docker/Dockerfile.transcriber
    container_name: parakeet-transcriber
    restart: unless-stopped

    # Use host networking for WebRTC UDP media traffic
    network_mode: host

    volumes:
      # Mount model directories (read-only)
      - ./tdt:/app/models/tdt:ro
      - ./diar_streaming_sortformer_4spk-v2.onnx:/app/models/diarization/model.onnx:ro
      # Mount audio files for testing (optional)
      - ./broadcast_2.wav:/tmp/broadcast_2.wav:ro
      # Mount frontend for live development (read-only)
      - ./frontend:/app/frontend:ro

    environment:
      # Server configuration
      - PORT=${PORT}
      - PUBLIC_IP=${PUBLIC_IP}
      - FRONTEND_PATH=/app/frontend

      # Model paths (match volume mounts)
      - TDT_MODEL_PATH=/app/models/tdt
      - DIAR_MODEL_PATH=/app/models/diarization/model.onnx

      # Transcription mode: set to "1" for speedy mode (recommended)
      - SPEEDY_MODE=${SPEEDY_MODE}

      # TURN server for NAT traversal (optional but recommended for public access)
      - TURN_SERVER=${TURN_SERVER}
      - TURN_USERNAME=${TURN_USERNAME}
      - TURN_PASSWORD=${TURN_PASSWORD}

      # Logging
      - RUST_LOG=${RUST_LOG}

    # Override entrypoint to keep container running
    # The transcriber will be started manually via docker exec
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]

    # stdin_open: true allows piping audio to the container
    stdin_open: true
    tty: true

    # Health check - disabled since we start transcriber manually
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 10s

networks:
  default:
    name: parakeet-webrtc
    driver: bridge
