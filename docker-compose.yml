# Docker Compose for parakeet-rs WebRTC Transcription
#
# Configuration is done entirely via environment variables.
# See docs/webrtc-transcription-architecture.md for full documentation.
#
# Usage:
#   # Start the container
#   docker compose up -d
#
#   # Run the transcriber with audio
#   docker exec parakeet-transcriber sh -c \
#     'ffmpeg -re -i /tmp/broadcast_2.wav -f s16le -ar 16000 -ac 1 - 2>/dev/null | \
#      /app/webrtc_transcriber --speedy'
#
#   # View logs
#   docker compose logs -f transcriber
#
#   # Stop all services
#   docker compose down

services:
  # WebRTC transcription server
  transcriber:
    build:
      context: .
      dockerfile: docker/Dockerfile.cpu
    container_name: parakeet-transcriber
    restart: unless-stopped

    # Use host networking for WebRTC UDP media traffic
    network_mode: host

    volumes:
      # Mount model directories (read-only)
      - ./tdt:/app/models/tdt:ro
      - ./diar_streaming_sortformer_4spk-v2.onnx:/app/models/diarization/model.onnx:ro
      - ./canary:/app/models/canary:ro
      - ./silero_vad.onnx:/app/models/silero_vad.onnx:ro
      # Mount audio files for testing (optional)
      - ./broadcast_2.wav:/tmp/broadcast_2.wav:ro
      # Mount media directory for multi-session support
      - ./media:/app/media
      # Mount frontend for live development (read-only)
      - ./frontend:/app/frontend:ro

    environment:
      # Server configuration
      - PORT=${PORT}
      - PUBLIC_IP=${PUBLIC_IP}
      - WS_HOST=${WS_HOST}
      - FRONTEND_PATH=/app/frontend

      # Model paths (match volume mounts)
      - TDT_MODEL_PATH=/app/models/tdt
      - DIAR_MODEL_PATH=/app/models/diarization/model.onnx
      - CANARY_MODEL_PATH=/app/models/canary
      - VAD_MODEL_PATH=/app/models/silero_vad.onnx
      - MEDIA_DIR=/app/media

      # CPU mode (explicit)
      - USE_GPU=false

      # Transcription mode: set to "1" for speedy mode (recommended)
      - SPEEDY_MODE=${SPEEDY_MODE}

      # TURN server for NAT traversal (optional but recommended for public access)
      - TURN_SERVER=${TURN_SERVER}
      - TURN_USERNAME=${TURN_USERNAME}
      - TURN_PASSWORD=${TURN_PASSWORD}

      # Logging
      - RUST_LOG=${RUST_LOG}

    # Start the multi-session WebRTC transcriber automatically
    entrypoint: ["/app/webrtc_transcriber"]

    # stdin_open: true allows piping audio to the container
    stdin_open: true
    tty: true

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Network configuration is not needed when using network_mode: host
